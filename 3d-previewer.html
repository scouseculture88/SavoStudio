<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pattern Previewer - Savo Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2d5016;
            --accent-green: #7cff50;
            --dark-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --border-color: #333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            background: linear-gradient(45deg, var(--accent-green), #9fd66b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .blank-selector {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .blank-selector h3 {
            color: var(--accent-green);
            margin-bottom: 15px;
        }

        .selected-blank {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(124, 255, 80, 0.1);
            border-radius: 10px;
            border: 1px solid var(--accent-green);
        }

        .selected-blank img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .blank-info h4 {
            color: var(--accent-green);
            margin-bottom: 5px;
        }

        .change-blank-btn {
            background: linear-gradient(45deg, var(--accent-green), #9fd66b);
            color: var(--primary-green);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: auto;
        }

        .change-blank-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(124, 255, 80, 0.3);
        }

        .no-blank-selected {
            text-align: center;
            padding: 40px;
            background: rgba(255, 80, 80, 0.1);
            border: 2px dashed #ff5050;
            border-radius: 10px;
        }

        .setup-btn {
            background: var(--accent-green);
            color: var(--primary-green);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 15px;
        }

        .real-blank-preview {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .real-blank-preview img {
            width: 100%;
            height: auto;
            border-radius: 15px;
        }

        .pattern-overlay {
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 40%;
            opacity: 0.8;
            border-radius: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .controls {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-color);
            height: fit-content;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            color: var(--accent-green);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .pattern-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pattern-option.active {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(124, 255, 80, 0.3);
        }

        .pattern-option:hover {
            transform: scale(1.05);
        }

        /* Pattern styles */
        .forest-camo {
            background: linear-gradient(45deg, #2d5016, #4a7c28, #1a3d0a, #7cff50);
            background-size: 20px 20px;
        }

        .urban-camo {
            background: linear-gradient(30deg, #333 25%, #666 25%, #666 50%, #999 50%, #999 75%, #333 75%);
            background-size: 15px 15px;
        }

        .desert-camo {
            background: linear-gradient(60deg, #d4a574, #c19a6b, #8b6f47, #f4d4a7);
            background-size: 18px 18px;
        }

        .arctic-camo {
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0, #d0d0d0, #ffffff);
            background-size: 22px 22px;
        }

        .gear-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .gear-option {
            padding: 12px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .gear-option.active {
            background: var(--accent-green);
            color: var(--dark-bg);
            font-weight: 600;
        }

        .logo-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .logo-style {
            display: flex;
            gap: 10px;
        }

        .logo-btn {
            flex: 1;
            padding: 8px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logo-btn.active {
            background: var(--accent-green);
            color: var(--dark-bg);
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .position-btn {
            aspect-ratio: 1;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .position-btn.active {
            background: var(--accent-green);
        }

        .position-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--text-primary);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .position-btn.active::after {
            background: var(--dark-bg);
        }

        /* Position specific dots */
        .pos-tl::after { top: 25%; left: 25%; }
        .pos-tc::after { top: 25%; left: 50%; }
        .pos-tr::after { top: 25%; left: 75%; }
        .pos-ml::after { top: 50%; left: 25%; }
        .pos-mc::after { top: 50%; left: 50%; }
        .pos-mr::after { top: 50%; left: 75%; }
        .pos-bl::after { top: 75%; left: 25%; }
        .pos-bc::after { top: 75%; left: 50%; }
        .pos-br::after { top: 75%; left: 75%; }

        .size-slider {
            width: 100%;
            margin-top: 10px;
        }

        .preview-area {
            background: var(--card-bg);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 600px;
            position: relative;
        }

        .gear-preview {
            position: relative;
            transition: all 0.5s ease;
        }

        /* 3D Gear Mockups */
        .water-bottle {
            width: 200px;
            height: 300px;
            background: linear-gradient(135deg, #2d5016, #4a7c28);
            border-radius: 25px 25px 15px 15px;
            position: relative;
            transform: perspective(600px) rotateY(-15deg) rotateX(5deg);
            box-shadow: 
                20px 20px 40px rgba(0,0,0,0.3),
                inset -5px -5px 10px rgba(0,0,0,0.2),
                inset 5px 5px 10px rgba(255,255,255,0.1);
        }

        .water-bottle::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 30px;
            background: #333;
            border-radius: 10px;
        }

        .cap {
            width: 180px;
            height: 120px;
            background: linear-gradient(135deg, #2d5016, #4a7c28);
            border-radius: 90px 90px 20px 20px;
            position: relative;
            transform: perspective(600px) rotateY(-10deg) rotateX(-20deg);
            box-shadow: 
                15px 15px 30px rgba(0,0,0,0.4),
                inset -3px -3px 8px rgba(0,0,0,0.3),
                inset 3px 3px 8px rgba(255,255,255,0.2);
        }

        .cap::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 10px;
            right: 10px;
            height: 15px;
            background: linear-gradient(90deg, #1a3d0a, #2d5016);
            border-radius: 0 0 10px 10px;
        }

        .jacket {
            width: 250px;
            height: 300px;
            background: linear-gradient(135deg, #2d5016, #4a7c28);
            border-radius: 20px;
            position: relative;
            transform: perspective(600px) rotateY(-8deg) rotateX(3deg);
            box-shadow: 
                18px 18px 35px rgba(0,0,0,0.3),
                inset -4px -4px 10px rgba(0,0,0,0.2),
                inset 4px 4px 10px rgba(255,255,255,0.1);
        }

        .jacket::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: #1a3d0a;
        }

        .backpack {
            width: 220px;
            height: 280px;
            background: linear-gradient(135deg, #2d5016, #4a7c28);
            border-radius: 15px;
            position: relative;
            transform: perspective(600px) rotateY(-12deg) rotateX(8deg);
            box-shadow: 
                16px 16px 32px rgba(0,0,0,0.4),
                inset -3px -3px 8px rgba(0,0,0,0.3),
                inset 3px 3px 8px rgba(255,255,255,0.15);
        }

        .tshirt-model {
            width: 200px;
            height: 240px;
            background: linear-gradient(135deg, #2d5016, #4a7c28);
            border-radius: 20px 20px 5px 5px;
            position: relative;
            transform: perspective(600px) rotateY(-10deg) rotateX(5deg);
            box-shadow: 
                15px 15px 30px rgba(0,0,0,0.3),
                inset -3px -3px 8px rgba(0,0,0,0.2),
                inset 3px 3px 8px rgba(255,255,255,0.1);
        }

        .tshirt-model::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -15px;
            right: -15px;
            height: 40px;
            background: linear-gradient(90deg, transparent, #2d5016, transparent);
            border-radius: 20px;
        }

        .sweatshirt-model {
            width: 230px;
            height: 260px;
            background: linear-gradient(135deg, #2d5016, #4a7c28);
            border-radius: 25px 25px 10px 10px;
            position: relative;
            transform: perspective(600px) rotateY(-8deg) rotateX(4deg);
            box-shadow: 
                18px 18px 35px rgba(0,0,0,0.3),
                inset -4px -4px 10px rgba(0,0,0,0.2),
                inset 4px 4px 10px rgba(255,255,255,0.1);
        }

        .sweatshirt-model::before {
            content: '';
            position: absolute;
            top: 30px;
            left: -20px;
            right: -20px;
            height: 50px;
            background: linear-gradient(90deg, transparent, #2d5016, transparent);
            border-radius: 25px;
        }

        .logo-overlay {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .logo-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: url('assets/savo-logo.jpg') center/cover;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .actions {
            margin-top: 30px;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-green), #9fd66b);
            color: var(--dark-bg);
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(124, 255, 80, 0.3);
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>3D Pattern Previewer</h1>
            <p>Visualize your tactical patterns on real gear</p>
        </div>

        <!-- Product Blank Selector -->
        <div class="blank-selector">
            <h3>üè≠ Product Blank</h3>
            <div id="selectedBlankDisplay">
                <div class="no-blank-selected">
                    <h4>No Product Blank Selected</h4>
                    <p>Upload photos of your actual product blanks for authentic previews</p>
                    <button class="setup-btn" onclick="setupProductBlanks()">Setup Product Blanks</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-panel">
                <div class="control-group">
                    <h3>Select Pattern</h3>
                    <div class="pattern-grid">
                        <div class="pattern-option forest-camo active" data-pattern="forest"></div>
                        <div class="pattern-option urban-camo" data-pattern="urban"></div>
                        <div class="pattern-option desert-camo" data-pattern="desert"></div>
                        <div class="pattern-option arctic-camo" data-pattern="arctic"></div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Select Product</h3>
                    <div class="gear-selector" id="productSelector">
                        <!-- Populated by JavaScript with real products -->
                    </div>
                    
                    <div class="product-details" id="productDetails" style="margin-top: 15px; padding: 15px; background: var(--dark-bg); border-radius: 8px; display: none;">
                        <h4 style="color: var(--accent-green); margin-bottom: 10px;">Product Details</h4>
                        <div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Base Price:</span>
                            <span id="basePrice">$0.00</span>
                        </div>
                        <div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Print Method:</span>
                            <span id="printMethod">DTG</span>
                        </div>
                        <div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Available Colors:</span>
                            <span id="colorCount">5</span>
                        </div>
                        <div class="color-options" id="colorOptions" style="margin-top: 10px;">
                            <!-- Color swatches populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Logo Style</h3>
                    <div class="logo-controls">
                        <div class="logo-style">
                            <button class="logo-btn active" data-style="circle">Circle Logo</button>
                            <button class="logo-btn" data-style="patch">Square Patch</button>
                        </div>
                        <div class="logo-style">
                            <button class="logo-btn" data-style="text-upper">SAVO MODE</button>
                            <button class="logo-btn" data-style="text-lower">savo mode</button>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 15px; margin-bottom: 10px; color: var(--text-secondary);">Position</h4>
                    <div class="position-grid">
                        <div class="position-btn pos-tl" data-pos="top-left"></div>
                        <div class="position-btn pos-tc" data-pos="top-center"></div>
                        <div class="position-btn pos-tr" data-pos="top-right"></div>
                        <div class="position-btn pos-ml active" data-pos="middle-left"></div>
                        <div class="position-btn pos-mc" data-pos="middle-center"></div>
                        <div class="position-btn pos-mr" data-pos="middle-right"></div>
                        <div class="position-btn pos-bl" data-pos="bottom-left"></div>
                        <div class="position-btn pos-bc" data-pos="bottom-center"></div>
                        <div class="position-btn pos-br" data-pos="bottom-right"></div>
                    </div>

                    <label style="display: block; margin-top: 15px; color: var(--text-secondary);">Size</label>
                    <input type="range" class="size-slider" min="20" max="80" value="40" id="logoSize">
                </div>
            </div>

            <div class="preview-area">
                <div class="gear-preview">
                    <div class="water-bottle" id="gearModel"></div>
                    <div class="logo-overlay" id="logoOverlay">
                        <div class="logo-image"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn-primary" onclick="downloadPreview()">Export Production Specs</button>
            <button class="btn-primary" onclick="saveToCollection()">Save to Collection</button>
            <button class="btn-primary" onclick="sharePreview()">Share Design</button>
            <button class="btn-primary" onclick="generateRealMockup()" style="background: linear-gradient(45deg, #ff6b35, #f7931e);">Generate Mockup</button>
        </div>
    </div>

    <script src="api/clothing-blanks.js"></script>
    <script>
        // Initialize clothing blanks API
        const clothingAPI = new ClothingBlanksAPI();
        
        // State management
        let currentPattern = 'forest';
        let currentProduct = null;
        let currentLogoStyle = 'circle';
        let currentPosition = 'middle-left';
        let currentSize = 40;
        let currentColor = 'black';

        // Real product categories
        const productCategories = {
            tshirt: clothingAPI.getProductsByCategory('tshirt'),
            hat: clothingAPI.getProductsByCategory('hat'),
            jacket: clothingAPI.getProductsByCategory('jacket'),
            bottle: clothingAPI.getProductsByCategory('bottle'),
            backpack: clothingAPI.getProductsByCategory('backpack')
        };

        // Pattern definitions with real color data
        const patterns = {
            forest: {
                type: 'forest',
                colors: ['#2d5016', '#4a7c28', '#1a3d0a', '#7cff50'],
                name: 'Forest Tactical'
            },
            urban: {
                type: 'urban', 
                colors: ['#333333', '#666666', '#999999', '#cccccc'],
                name: 'Urban Digital'
            },
            desert: {
                type: 'desert',
                colors: ['#d4a574', '#c19a6b', '#8b6f47', '#f4d4a7'],
                name: 'Desert Storm'
            },
            arctic: {
                type: 'arctic',
                colors: ['#f0f0f0', '#e0e0e0', '#d0d0d0', '#ffffff'],
                name: 'Arctic Ops'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSelectedBlank();
            populateProducts();
            updatePreview();
            bindEvents();
        });

        function populateProducts() {
            const productSelector = document.getElementById('productSelector');
            const allProducts = [
                ...productCategories.tshirt,
                ...productCategories.hat,
                ...productCategories.jacket,
                ...productCategories.bottle,
                ...productCategories.backpack
            ];

            allProducts.forEach((product, index) => {
                const productDiv = document.createElement('div');
                productDiv.className = `gear-option ${index === 0 ? 'active' : ''}`;
                productDiv.dataset.productId = product.id;
                productDiv.innerHTML = `
                    <div style="font-weight: 600;">${product.name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                        ${product.category.toUpperCase()} - $${product.price}
                    </div>
                `;
                productSelector.appendChild(productDiv);
            });

            // Set initial product
            if (allProducts.length > 0) {
                currentProduct = allProducts[0];
                updateProductDetails();
            }
        }

        function bindEvents() {
            // Pattern selection
            document.querySelectorAll('.pattern-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('.pattern-option.active').classList.remove('active');
                    this.classList.add('active');
                    currentPattern = this.dataset.pattern;
                    updatePreview();
                });
            });

            // Product selection (updated to handle real products)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.gear-option')) {
                    const gearOption = e.target.closest('.gear-option');
                    document.querySelector('.gear-option.active')?.classList.remove('active');
                    gearOption.classList.add('active');
                    
                    const productId = gearOption.dataset.productId;
                    currentProduct = clothingAPI.getProduct(productId);
                    updateProductDetails();
                    updateGearModel();
                }
            });

            // Logo style
            document.querySelectorAll('.logo-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('.logo-btn.active').classList.remove('active');
                    this.classList.add('active');
                    currentLogoStyle = this.dataset.style;
                    updateLogo();
                });
            });

            // Position selection
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('.position-btn.active').classList.remove('active');
                    this.classList.add('active');
                    currentPosition = this.dataset.pos;
                    updateLogoPosition();
                });
            });

            // Size slider
            document.getElementById('logoSize').addEventListener('input', function() {
                currentSize = this.value;
                updateLogoSize();
            });
        }

        function updatePreview() {
            const gearModel = document.getElementById('gearModel');
            gearModel.style.background = patterns[currentPattern];
            gearModel.style.backgroundSize = '20px 20px';
        }

        function updateGearModel() {
            if (!currentProduct) return;
            
            const gearModel = document.getElementById('gearModel');
            
            // Map product categories to CSS classes
            const categoryClasses = {
                'tshirt': 'tshirt-model',
                'sweatshirt': 'sweatshirt-model', 
                'hat': 'cap',
                'bag': 'backpack',
                'backpack': 'backpack',
                'jacket': 'jacket',
                'bottle': 'water-bottle'
            };
            
            const modelClass = categoryClasses[currentProduct.category] || 'water-bottle';
            gearModel.className = modelClass;
            
            updatePreview();
            updateLogoPosition();
        }

        function updateLogo() {
            const logoOverlay = document.getElementById('logoOverlay');
            
            switch(currentLogoStyle) {
                case 'circle':
                    logoOverlay.innerHTML = '<div class="logo-image"></div>';
                    break;
                case 'patch':
                    logoOverlay.innerHTML = '<div class="logo-image" style="border-radius: 8px; width: 50px; height: 50px;"></div>';
                    break;
                case 'text-upper':
                    logoOverlay.innerHTML = '<span style="font-family: Bebas Neue; font-size: 1.2rem; letter-spacing: 2px;">SAVO MODE</span>';
                    break;
                case 'text-lower':
                    logoOverlay.innerHTML = '<span style="font-family: Inter; font-size: 1rem; font-weight: 500;">savo mode</span>';
                    break;
            }
            
            updateLogoPosition();
            updateLogoSize();
        }

        function updateLogoPosition() {
            const logoOverlay = document.getElementById('logoOverlay');
            const positions = {
                'top-left': { top: '20px', left: '20px' },
                'top-center': { top: '20px', left: '50%', transform: 'translateX(-50%)' },
                'top-right': { top: '20px', right: '20px' },
                'middle-left': { top: '50%', left: '20px', transform: 'translateY(-50%)' },
                'middle-center': { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                'middle-right': { top: '50%', right: '20px', transform: 'translateY(-50%)' },
                'bottom-left': { bottom: '20px', left: '20px' },
                'bottom-center': { bottom: '20px', left: '50%', transform: 'translateX(-50%)' },
                'bottom-right': { bottom: '20px', right: '20px' }
            };

            const pos = positions[currentPosition];
            Object.assign(logoOverlay.style, pos);
        }

        function updateLogoSize() {
            const logoOverlay = document.getElementById('logoOverlay');
            logoOverlay.style.fontSize = (currentSize / 40) + 'rem';
            
            const logoImage = logoOverlay.querySelector('.logo-image');
            if (logoImage) {
                const size = currentSize + 'px';
                logoImage.style.width = size;
                logoImage.style.height = size;
            }
        }

        function updateProductDetails() {
            if (!currentProduct) return;

            const detailsPanel = document.getElementById('productDetails');
            const basePrice = document.getElementById('basePrice');
            const printMethod = document.getElementById('printMethod');
            const colorCount = document.getElementById('colorCount');
            const colorOptions = document.getElementById('colorOptions');

            // Show details panel
            detailsPanel.style.display = 'block';

            // Update pricing
            basePrice.textContent = `$${currentProduct.price}`;

            // Recommend print method
            const patternData = patterns[currentPattern];
            const recommended = clothingAPI.recommendPrintMethod(currentProduct, patternData);
            printMethod.textContent = recommended;

            // Show available colors
            colorCount.textContent = currentProduct.colors.length;

            // Create color swatches
            colorOptions.innerHTML = '';
            currentProduct.colors.forEach(color => {
                const colorSwatch = document.createElement('div');
                colorSwatch.className = 'color-swatch';
                colorSwatch.style.cssText = `
                    width: 25px; height: 25px; border-radius: 50%; margin: 2px;
                    display: inline-block; cursor: pointer; border: 2px solid transparent;
                    background-color: ${this.getColorHex(color)};
                `;
                colorSwatch.dataset.color = color;
                
                if (color === currentColor) {
                    colorSwatch.style.borderColor = 'var(--accent-green)';
                }

                colorSwatch.addEventListener('click', () => {
                    currentColor = color;
                    updateProductDetails();
                    updatePreview();
                });

                colorOptions.appendChild(colorSwatch);
            });
        }

        function getColorHex(colorName) {
            const colorMap = {
                'black': '#000000',
                'white': '#ffffff',
                'navy': '#001f3f',
                'forest-green': '#2d5016',
                'charcoal': '#36454f',
                'heather-grey': '#888888',
                'khaki': '#c3b091',
                'olive': '#808000',
                'maroon': '#800000'
            };
            return colorMap[colorName] || '#cccccc';
        }

        // Real product blank management
        function checkSelectedBlank() {
            const selectedBlank = localStorage.getItem('selectedProductBlank');
            if (selectedBlank) {
                const blank = JSON.parse(selectedBlank);
                displaySelectedBlank(blank);
            }
        }

        function displaySelectedBlank(blank) {
            const display = document.getElementById('selectedBlankDisplay');
            display.innerHTML = `
                <div class="selected-blank">
                    <img src="${blank.image}" alt="${blank.name}">
                    <div class="blank-info">
                        <h4>${blank.name}</h4>
                        <p>${blank.brand} - ${blank.type}</p>
                        <small>$${blank.price} ‚Ä¢ ${blank.colors}</small>
                    </div>
                    <button class="change-blank-btn" onclick="setupProductBlanks()">Change Blank</button>
                </div>
            `;
            
            // Update preview to use real blank
            updatePreviewWithRealBlank(blank);
        }

        function updatePreviewWithRealBlank(blank) {
            const preview = document.getElementById('preview');
            if (preview) {
                preview.innerHTML = `
                    <div class="real-blank-preview">
                        <img src="${blank.image}" alt="${blank.name}" id="blankBackground">
                        <div class="pattern-overlay" id="patternOverlay"></div>
                        <div class="logo-overlay" id="logoOverlay"></div>
                    </div>
                `;
                
                // Apply current pattern to overlay
                applyPatternToOverlay();
                updateLogoOverlay();
            }
        }

        function applyPatternToOverlay() {
            const overlay = document.getElementById('patternOverlay');
            if (overlay) {
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Generate pattern on canvas
                const patternData = patterns[currentPattern];
                clothingAPI.applyPattern(ctx, patternData);
                
                // Convert to background image
                overlay.style.backgroundImage = `url(${canvas.toDataURL()})`;
                overlay.style.backgroundSize = 'cover';
            }
        }

        function updateLogoOverlay() {
            const logoOverlay = document.getElementById('logoOverlay');
            if (logoOverlay) {
                logoOverlay.innerHTML = getLogoContent();
                updateLogoPosition();
                updateLogoSize();
            }
        }

        function setupProductBlanks() {
            window.location.href = 'product-blank-manager.html';
        }

        // Override updatePreview to work with real blanks
        function updatePreview() {
            const selectedBlank = localStorage.getItem('selectedProductBlank');
            if (selectedBlank) {
                const blank = JSON.parse(selectedBlank);
                updatePreviewWithRealBlank(blank);
            } else {
                // Show setup message
                const preview = document.getElementById('preview');
                if (preview) {
                    preview.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; background: rgba(255, 80, 80, 0.1); border-radius: 15px; border: 2px dashed #ff5050;">
                            <h3>Setup Required</h3>
                            <p>Upload photos of your actual product blanks for authentic previews</p>
                            <button class="setup-btn" onclick="setupProductBlanks()" style="margin-top: 15px;">Setup Product Blanks</button>
                        </div>
                    `;
                }
            }
        }

        async function generateRealMockup() {
            if (!currentProduct) return;

            const patternData = patterns[currentPattern];
            const logoData = {
                style: currentLogoStyle,
                position: currentPosition,
                size: currentSize / 40,
                placement: 'front',
                color: currentColor
            };

            try {
                const mockupUrl = await clothingAPI.generateMockup(
                    currentProduct.id,
                    patternData,
                    logoData
                );
                
                // Update preview with real mockup
                const gearModel = document.getElementById('gearModel');
                gearModel.style.backgroundImage = `url(${mockupUrl})`;
                gearModel.style.backgroundSize = 'cover';
                gearModel.style.backgroundPosition = 'center';
                
            } catch (error) {
                console.log('Generating pattern preview locally');
                updatePreview(); // Fallback to local generation
            }
        }

        function exportDesignSpecs() {
            if (!currentProduct) return;

            const patternData = patterns[currentPattern];
            const specs = clothingAPI.exportForProduction(currentProduct.id, patternData);
            
            const exportData = {
                productDetails: {
                    name: currentProduct.name,
                    id: currentProduct.id,
                    category: currentProduct.category,
                    basePrice: currentProduct.price,
                    selectedColor: currentColor
                },
                design: {
                    pattern: currentPattern,
                    patternName: patternData.name,
                    logoStyle: currentLogoStyle,
                    logoPosition: currentPosition,
                    logoSize: currentSize
                },
                productionSpecs: specs.designSpecs,
                notes: specs.productionNotes,
                pricing: clothingAPI.getProductPricing(currentProduct.id, 24) // Sample order
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `savo-mode-${currentProduct.id}-${currentPattern}-specs.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadPreview() {
            exportDesignSpecs();
        }

        function saveToCollection() {
            const designData = {
                product: currentProduct,
                pattern: currentPattern,
                logoStyle: currentLogoStyle,
                position: currentPosition,
                size: currentSize,
                color: currentColor,
                timestamp: new Date().toISOString()
            };

            // Save to localStorage for now
            let collection = JSON.parse(localStorage.getItem('savoModeCollection') || '[]');
            collection.push(designData);
            localStorage.setItem('savoModeCollection', JSON.stringify(collection));

            alert(`Design saved! You now have ${collection.length} designs in your collection.`);
        }

        function sharePreview() {
            const designUrl = new URL(window.location);
            designUrl.searchParams.set('product', currentProduct?.id || '');
            designUrl.searchParams.set('pattern', currentPattern);
            designUrl.searchParams.set('logo', currentLogoStyle);
            designUrl.searchParams.set('position', currentPosition);
            designUrl.searchParams.set('size', currentSize);

            navigator.clipboard.writeText(designUrl.toString()).then(() => {
                alert('Design link copied to clipboard! Share with your team.');
            });
        }
    </script>
</body>
</html>